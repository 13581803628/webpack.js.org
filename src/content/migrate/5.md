---
title: 从 v4 升级到 v5
sort: 1
contributors:
  - sokra
  - salemhilal
  - keichinger
  - EugeneHlushko
  - MattGoldwater
  - rramaa
---

本指南目标是帮助你在使用 webpack 的时候直接迁移到 webpack 5。如果你使用运行 webpack 更底层的工具，请
参考工具有关迁移的指引。


## 准备工作 {#preparations}

webpack 5 要求至少 Node.js 10.13.0 (LTS)。

T> 使用较新的 Node.js 版本能够改善构建性能。

### 升级 webpack 以及它的依赖 {#upgrade-webpack-and-its-dependencies}

#### 将 webpack 4 升级到最新的可用版本 {#upgrade-webpack-4-to-the-latest-available-version}

当使用 webpack >= 4 的版本, 升级到最新的 webpack 4 版本不需要额外的指南。
如果你使用低于 4 的 webpack 版本，请参考 [webpack 4 迁移指南](/migrate/4/)。

#### 将 webpack-cli 升级到最新的可用版本 (当有使用的时候) {#upgrade-webpack-cli-to-the-latest-available-version-when-used}

#### 将所有使用的 plugin 和 loader 升级到最新的可用版本 {#upgrade-all-used-plugins-and-loaders-to-the-latest-available-version}

必须使用已适配 webpack 5 的 plugin 和 loader，它们可能存在 beta 版本。

W> 当你升级到重大版本的时候，请参考相关 plugin 和 loader 的迁移指南。

W> ExtendedAPIPlugin 已被移除，它的逻辑已经被整合到 [`APIPlugin`](https://github.com/webpack/webpack/blob/master/lib/APIPlugin.js) 当中。

#### 确保你的构建没有错误与警告 {#make-sure-your-build-has-no-errors-or-warnings}

可能生成新的错误或警告，这是由于 webpack, webpack-cli，plugin 或 loader 升级版本导致。
请关注构建时相关的废弃警告。

你可以使用如下方式调用 webpack，以追踪废弃告警的栈堆信息，并推断出是由哪个 plugin 或 loader 引起的。

```bash
node --trace-deprecation node_modules/webpack/bin/webpack.js
```

W> webpack 5 会移除所有废弃的特性。为了无障碍的推进，应保证在构建时再无任何的废弃警告。

#### 确保你使用的是 stats 中的入口信息 {#make-sure-you-are-using-entry-point-information-from-stats}

T> 如果你正使用 [HtmlWebpackPlugin](/plugins/html-webpack-plugin/)，可跳过该步骤。

当使用静态 HTML 或通过其它的方式生成 HTML 时，请确保使用的 entry 是从 stats 的 JSON 中获取到的，再生成 `<script>`，`<style>` 以及 `<link>` 标签。

如果无法做到这一点，请不要设置 `splitChunks.chunks: 'all'` 和 `splitChunks.maxSize`。请注意，这是并不是最理想的解决方案。

#### 请确保设置了 `mode` {#make-sure-to-use-mode}

将 mode 设置成 [`production`](/configuration/mode/#mode-production) 或 [`development`](/configuration/mode/#mode-development) 以确保相应的默认值被设置。

#### 升级废弃的配置项 {#update-outdated-options}

如有使用以下的配置项，请升级至最新的版本：

- `optimization.hashedModuleIds: true` ↦ `optimization.moduleIds: 'hashed'`
- `optimization.namedChunks: true` ↦ `optimization.chunkIds: 'named'`
- `optimization.namedModules: true` ↦ `optimization.moduleIds: 'named'`
- `NamedModulesPlugin` ↦ `optimization.moduleIds: 'named'`
- `NamedChunksPlugin` ↦ `optimization.chunkIds: 'named'`
- `HashedModulesPlugin` ↦ `optimization.moduleIds: 'hashed'`
- `optimization.occurrenceOrder: true` ↦ `optimization: { chunkIds: 'total-size', moduleIds: 'size' }`
- `optimization.splitChunks.cacheGroups.vendors` ↦ `optimization.splitChunks.cacheGroups.defaultVendors`
- `Compilation.entries` ↦ `Compilation.entryDependencies`
- `serve` ↦ `serve` 已被移除，推荐使用 [`DevServer`](/configuration/dev-server/)

#### 测试 webpack 5 兼容性 {#test-webpack-5-compatibility}

尝试在 webpack 4 的配置中添加如下选项，检查一下构建是否仍然正确的运行。

```javascript
module.exports = {
  // ...
  node: {
    Buffer: false,
    process: false
  }
};
```

<<<<<<< HEAD
T> webpack 5 移除的配置会永远设置成 `false`。在升级至 webpack 5 时，必须删除这些配置。
=======
T> webpack 5 removes these options from the configuration schema and will always use `false`.

You have to remove these options again when upgrading your configuration for webpack 5.
>>>>>>> ef81ee1f2d496c6a49e61e34ffb7692db1ba54e7

#### 升级 webpack 版本 {#upgrade-webpack-version}

npm：`npm install webpack@next --dev`

Yarn：`yarn add webpack@next -D`

#### 清理配置 {#clean-up-configuration}

- 请考虑将 `optimization.moduleIds` 和 `optimization.chunkIds` 从你 webpack 配置中移除。使用默认值会更合适，因为它们会在 [`production 模式`](/configuration/mode/#mode-production) 下支持长效缓存且可以在 [`development` 模式](/configuration/mode/#mode-development)下进行调试。
- 当 webpack 配置中使用了 `[hash]` 占位符时，请考虑将它改为 `[contenthash]`。效果一致，但事实证明会更为有效。
- 如果你使用了 Yarn 的 PnP 以及 `pnp-webpack-plugin` 插件，你可以将其从配置中移除，因为它已被默认支持。
- 如果你使用了带有正则表达式参数的 `IgnorePlugin`，现已支持传入一个 `options` 对象：`new IgnorePlugin({ resourceRegExp: /regExp/ })`。

<<<<<<< HEAD
如果通过 import 使用了 WASM，应遵循以下两点：
=======
If you were using WebAssembly via import, you should follow this two step process:
>>>>>>> ef81ee1f2d496c6a49e61e34ffb7692db1ba54e7

- 在配置增加 `experiments.syncWebAssembly: true` 配置，以启用废弃提醒，获得在 webpack 4 中的相同行为。
- 在成功升级至 webpack 5 以后，应将 `experiments` 的值改为 `experiments: { asyncWebAssembly: true }` 以使用最新规范的 WASM。

重新思考 `optimization.splitChunks`:

<<<<<<< HEAD
- 推荐使用默认配置或使用 `optimization.splitChunks: { chunks: 'all' }` 配置。
- 当使用 HTTP/2 和长效缓存时，应设置 `optimization.splitChunks: { chunks: 'all', maxInitialRequests: 30, maxAsyncRequests: 30, maxSize: 100000 }`。
- 当使用自定义配置，将 `name` 替换为 `idHint`。
- 使用 `optimization.splitChunks: { default: false, vendors: false }` 配置可以关闭默认值。但我们不推荐这么做，如果你需要在 webpack 5 中获得与之相同的效果：请将配置改为 `optimization.splitChunks: { default: false, defaultVendors: false }`。

#### 清理代码 {#cleanup-the-code}
=======
- It's recommended to use either the defaults or `optimization.splitChunks: { chunks: 'all' }`.
- When using a custom configuration, replace `name` with `idHint`.
- It was possible to turn off the defaults by setting `optimization.splitChunks: { default: false, vendors: false }`. We don't recommend doing this, but if you really want to get the same effect in webpack 5: `optimization.splitChunks: { default: false, defaultVendors: false }`.

Consider removing defaults:

- Using `entry: './src/index.js'`: you can omit it, that's the default.
- Using `output.path: path.resolve(__dirname, 'dist')`: you can omit it, that's the default.
- Using `output.filename: '[name].js'`: you can omit it, that's the default.

Need to support an older browser?

- By default, webpack will use your browserslist config to decide which code style to emit.
- Without a browserslist it would emit ES6 style. You can use `target: ["web", "es5"]` to change it to ES5.
- For Node.js, builds include the supported Node.js version in the `target` option and webpack will automatically figure out which syntax is supported, e. g. `target: 'node8.6'`.

#### Cleanup the code
>>>>>>> ef81ee1f2d496c6a49e61e34ffb7692db1ba54e7

使用 `/* webpackChunkName: '...' */` 时：请确保你了解其意图：

- 此处 chunk 的名称本意是 public 的。
- 它不只是用于开发模式的名称。
- webpack 会在 production 以及 development 的模式中使用它对文件进行命名。
- 即使不使用 `webpackChunkName`，webpack 5 也会自动在 `development` 模式下分配有意义的文件名。

<<<<<<< HEAD
对 JSON 模块使用命名导出：新规范中已不再支持此功能，因此会收到警告。请使用 `import package from './package.json'; const { version } = package;` 替换 `import { version } from './package.json'`。
=======
Using named exports from JSON modules: this is not supported by the new specification and you will get a warning. Instead of `import { version } from './package.json'; console.log(version);` use `import package from './package.json'; console.log(package.version);`
>>>>>>> ef81ee1f2d496c6a49e61e34ffb7692db1ba54e7

#### 清理构建代码 {#cleanup-the-build-code}

<<<<<<< HEAD
- 当使用 `const compiler = webpack(...);`，确保在使用完毕后，使用 `compiler.close();` 关闭编译器。
=======
- When using `const compiler = webpack(...);`, make sure to close the compiler after using it: `compiler.close(callback);`.
    - This doesn't apply to the `webpack(..., callback)` form which automatically closes.
    - This is optional if you use webpack in watching mode until the user ends the process. The idle phases in watch mode will be used for this kind of work.
>>>>>>> ef81ee1f2d496c6a49e61e34ffb7692db1ba54e7

#### 运行单个构建并遵循以下建议 {#run-a-single-build-and-follow-advises}

<<<<<<< HEAD
如果没有相关的建议？请创建一个 issue，我们会尝试解决它。重复以下的步骤，直到你至少解决到 Level 3 或 Level 4：

- Level 1: 模式（Schema）校验失败。配置选项已更改。应该要有校验失败的信息且附上 `BREAKING CHANGE:` 提示。
- Level 2: webpack 异常退出并出现错误。错误信息应告诉你哪里需要进行修改。
- Level 3: 构建错误。错误信息应该要有 `BREAKING CHANGE:` 提示。
- Level 4: 构建警告。警告信息应该告诉你哪里需要进行修改。

废弃警告。你可能会得到许多废弃的警告。但问题不大。插件需要时间来追上 webpack 内核的变化。请忽略这些警告，直到 Beta 版本发布为止。

- 你使用带有 `--no-deprecation` 选项的 node 运行 webpack，可以隐藏废弃告警，例如：`node --no-deprecation node_modules/webpack/bin/webpack.js`。但这只能作为临时的解决方案。
- plugin 和 loader 的开发者，应遵循弃用信息中的建议以改进代码。
=======
Please make sure to read errors/warnings carefully.

If there is no corresponding advise? Please create an issue and we will try to resolve it. Repeat this step until you solved at least level 3 or 4:

- Level 1: Schema validation fails. Configuration options have changed. There should be a validation error with a `BREAKING CHANGE:` note, or a hint which option should be used instead.
- Level 2: webpack exits with an error. The error message should tell you what needs to be changed.
- Level 3: Build Errors. The error message should have a `BREAKING CHANGE:` note.
- Level 4: Build Warnings. The warning message should tell you what can be improved.
- Level 5: Runtime Errors. This is tricky. You probably have to debug to find the problem. A general advise is difficult here.
- Level 6: Deprecation Warnings. You probably get a lot of deprecation warnings. This is not directly a problem. Plugins need time to catch up with core changes. Please report these deprecations to the plugins. These deprecations are only warnings and the build will still work with only minor drawbacks (like less performance).
- Level 7: Performance issues. Usually performance should improve with webpack 5, but there are also a few cases where performance get worse.

- Regarding Runtime Errors:
    - `process` is not defined.
        - webpack 5 does no longer include a polyfill for this Node.js variable. Avoid using it in the frontend code.
        - Want to support frontend and browser usage? Use the `exports` or `imports` package.json field to use different code depending on the environment.
            - Also use the `browser` field to support older bundlers,.
            - Alternative: Wrap code blocks with the `typeof process` checks. Note that this will have a negative impact on the bundle size.
        - Want to use environment variables with `process.env.VARIABLE`? You need to use the `DefinePlugin` or `EnvironmentPlugin` to define these variables in the configuration.
            - Consider using `VARIABLE` instead and make sure to check `typeof VARIABLE !== 'undefined'` too. `process.env` is Node.js specific and should be avoided in frontend code.
    - 404 errors pointing to URLs containing `auto`
        - Not all ecosystem tooling is ready for the new default automatic `publicPath` via `output.publicPath: "auto"`
            - Use a static `output.publicPath: ""` instead.
- Regarding Deprecation Warnings:
    - You can hide deprecation warnings by running node with `--no-deprecation` flag, e.g.: `node --no-deprecation node_modules/webpack/bin/webpack.js`. This should only be a temporary workaround.
    - Plugins and Loaders contributors can follow the advises in the deprecation messages to improve the code.
- Regarding Performance issues:
    - Profile where the time is spend.
        - `--profile --progress` displays a very simple performance profile now
        - `node --inspect-brk node_modules/webpack/bin/webpack.js` + [`chrome://inspect`](chrome://inspect) / [`edge://inspect`](edge://inspect) (see profiler tab).
            - You can save these profiles to files and provide them in issues.
            - Try using `--no-turbo-inlining` flag for better stack traces in some cases
    - Time for building modules in incremental builds can be improved by reverting to unsafe caching like in webpack 4:
        - `module.unsafeCache: true`
        - But this might affect the ability to handle some of the changes to the code base
    - Full build
        - Backward-compatibility layer for the deprecated features will usually have worse performance compared to the new features.
        - Creating many warnings can affect build performance, even if they are ignored.
        - Source Maps are expensive. Check [`devtool`](/configuration/devtool/) option in the documentation to see a comparison of the different options.
        - Anti-Virus protection might affect performance of the file system access.
        - Persistent Caching can help to improve the repetitive full builds.
        - Module Federation allows to split the application into multiple smaller builds.
>>>>>>> ef81ee1f2d496c6a49e61e34ffb7692db1ba54e7

#### 如有需要，在 runtime 代码中禁用 ES2015 语法 {#turn-off-es2015-syntax-in-runtime-code-if-necessary}

<<<<<<< HEAD
默认地，webpack 的 runtime 代码会使用 ES2015 语法以使得构建出来的包体积更小。如果你构建的目标环境中不支持这种语法（比如 IE11），你需要设置 `output.ecmaVersion: 5` 将代码转换为 ES5 语法。
=======
By default, webpack's runtime code uses ES2015 syntax to build smaller bundles. If your build targets environments that don't support this syntax (like IE11), you'll need to set `target: ['web', 'es5']` to revert to ES5 syntax (`'web'` if target environment is browser).
>>>>>>> ef81ee1f2d496c6a49e61e34ffb7692db1ba54e7

#### 所有情况都运行如常？ {#everything-works}

如果你成功地迁移至 webpack 5。请[发推 @ 我们](https://twitter.com/intent/tweet?source=https://webpack.js.org/migrate/5/&text=I%20just%20migrated%20to%20webpack%205%20using%20its%20migration%20guide!%20&via=webpack&hashtags=webpack,webpack5)。

#### 运行异常？ {#it-is-not-working}

创建一个 [issue](https://github.com/webpack/webpack/issues/new?template=Bug_report.md) 并告诉我们在迁移过程中你遇到的问题。

#### 发现本指南中缺失的东西？ {#something-missing-in-this-guide}

请提交 Pull Request 以帮助其他开发者更好地使用该指南。

## 内核的改变 {#changes-to-internals}

如果你对内核感兴趣，此处会列出 webpack 内核相关的变更，如：添加类型，代码重构和方法重命名等。但这些变化并不会作为迁移通用案例的一部份。

- `Module.nameForCondition`，`Module.updateCacheModule` 以及 `Module.chunkCondition` 不再可选。

### loader 的 getOptions 方法 {#getoptions-method-for-loaders}

webpack 5 发布后，在 loader 的上下文中，会带有内置的 [`this.getOptions`](/api/loaders/#thisgetoptionsschema) 方法。这对于那些使用之前推荐 [schema-utils](https://github.com/webpack/schema-utils) 中的 `getOptions` 方法的 loader 而言，这是一个重大更新：

- `this.getOptions` 自 webpack 5 起支持使用
- 它支持将 JSON 作为查询字符串，而不仅仅是 JSON5：如 `?{arg:true}` ↦ `?{"arg":true}`。在相应的 loader 文档中，应推荐使用 JSON 并不推荐使用 JSON5。
- [`loader-utils`](https://github.com/webpack/loader-utils) 拥有解析查询字符串的特定行为（如 `true`，`false` 以及 `null` 不会被解析成 `string` 而是原始类型的值）。这对于新的内置 `this.getOptions` 方法来说，不再适用，它使用 Node 原生的 [`querystring`](https://nodejs.org/api/querystring.html) 方法进行解析。此时，需在 loader 中使用 `this.getOptions` 获取配置选项之后，根据情况添加自定义行为。
- 模式(Schema) 参数对新的 `this.getOptions` 方法而言是可选的，但我们强烈建议给你的 loader 选项添加模式校验。模式中的 `title` 字段，可用于自定义校验的错误信息，比如 `"title": "My Loader ooooptions"` 会在这种方式展示错误信息：`Invalid ooooptions object. My Loader has been initialised using an ooooptions object that does not match the API schema. - ooooptions.foo.bar.baz should be a string.`。
